<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Manga Reader</title>

<style>
body { margin:0; background:#0b0b0b; color:#fff; font-family:Arial }
.top { position:sticky; top:0; background:#111; padding:10px; display:flex; gap:10px; align-items:center; z-index:10; flex-wrap:wrap }
button { padding:8px 10px; cursor:pointer }
.wrap { max-width:980px; margin:auto; padding:10px }
img { width:100%; display:block; margin-bottom:10px; user-select:none }
small { opacity:.7 }
</style>
</head>

<body>
<div class="top">
  <strong id="info">Carregando…</strong>
  <button id="mode">Modo: Página</button>
  <button id="prev">◀</button>
  <button id="next">▶</button>
  <small id="status"></small>
</div>

<div class="wrap" id="content"></div>

<!--<script src="pako.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script>
function b64ToBytes(b64) {
  const pad = '='.repeat((4 - b64.length % 4) % 4);
  const base = (b64 + pad).replace(/-/g,'+').replace(/_/g,'/');
  const raw = atob(base);
  return Uint8Array.from(raw, c => c.charCodeAt(0));
}

function isAllowedImage(url) {
  const u = (url || '').trim().toLowerCase();
  return u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.png');
}

const content = document.getElementById('content');
const status  = document.getElementById('status');
const info    = document.getElementById('info');
const modeBtn = document.getElementById('mode');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');

const params = new URLSearchParams(location.hash.substring(1));
const payload = params.get('data');

if (!payload) {
  content.innerHTML = 'Link inválido';
  throw new Error('no data');
}

let text;
try {
  text = new TextDecoder().decode(pako.ungzip(b64ToBytes(payload)));
} catch (e) {
  content.innerHTML = 'Erro ao decodificar o link (#data inválido).';
  throw e;
}

// divide por \n ou \r\n e filtra extensões
const pages = text
  .split(/\r?\n+/)
  .map(x => x.trim())
  .filter(Boolean)
  .filter(isAllowedImage);

if (!pages.length) {
  content.innerHTML = 'Nenhuma imagem válida encontrada (.jpg/.png).';
  throw new Error('no pages');
}

let idx  = 0;
let mode = localStorage.getItem('mode') || 'page'; // 'page' | 'scroll'

function setHeader() {
  info.textContent = `Leitor (${pages.length} páginas)`;
  modeBtn.textContent = `Modo: ${mode === 'page' ? 'Página' : 'Scroll'}`;

  // Em scroll, esconde navegação
  prevBtn.style.display = (mode === 'page') ? '' : 'none';
  nextBtn.style.display = (mode === 'page') ? '' : 'none';
}

function renderPage() {
  content.innerHTML = '';
  const img = document.createElement('img');
  img.src = pages[idx];
  img.draggable = false;
  img.onclick = () => {
    // no celular, clicar avança (somente no modo página)
    if (window.innerWidth < 900) next();
  };
  content.appendChild(img);
  status.textContent = `Página ${idx + 1}/${pages.length}`;
}

function renderScroll() {
  content.innerHTML = '';
  for (const u of pages) {
    const img = document.createElement('img');
    img.src = u;
    img.draggable = false;
    content.appendChild(img);
  }
  status.textContent = `${pages.length} páginas`;
}

function applyMode() {
  setHeader();
  if (mode === 'page') renderPage();
  else renderScroll();
}

function next() {
  if (mode !== 'page') return;
  if (idx < pages.length - 1) { idx++; renderPage(); }
}

function prev() {
  if (mode !== 'page') return;
  if (idx > 0) { idx--; renderPage(); }
}

nextBtn.onclick = next;
prevBtn.onclick = prev;

modeBtn.onclick = () => {
  mode = (mode === 'page') ? 'scroll' : 'page';
  localStorage.setItem('mode', mode);
  applyMode();
};

window.onkeydown = (e) => {
  if (mode !== 'page') return;
  if (e.key === 'ArrowRight') next();
  if (e.key === 'ArrowLeft') prev();
};

// inicia
applyMode();
</script>
</body>
</html>
